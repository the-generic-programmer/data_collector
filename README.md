# data_collector

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)
[![ROS 2: Humble](https://img.shields.io/badge/ROS2-Humble-blue.svg)](https://docs.ros.org/en/humble/index.html)

A robust ROS 2 package for collecting, logging, and live-streaming flight telemetry from SITL and AP_DDS sources. Data is saved as CSV or compressed CSV (`.csv.gz`) for later analysis, and can be streamed live to TCP clients for real-time monitoring. Now includes a machine learning pipeline for real-time weather prediction from drone data.

---

## Directory Structure (Short)

```text
.  
├── LICENSE  
├── README.md  
├── package.xml  
├── setup.cfg  
├── setup.py  
├── __init__.py  # (legacy, not required for ROS 2)
├── data_collector/  # Main Python package
│   ├── __init__.py  
│   ├── my_node.py  # Main logger node
│   ├── logs/  # Default output directory for log files (created automatically)
│   ├── ml_weather/  # Machine learning weather prediction
│   │   ├── train_model.py  # Model training script
│   │   └── predict.py  # Real-time prediction client
├── build/  # Auto-generated by colcon (build artifacts)
├── install/  # Auto-generated by colcon (install artifacts)
├── log/  # Build logs (auto-generated, not used by logger)
├── logs/  # (Legacy or extra logs, not used by default)
├── README/  # Additional documentation
├── resource/  # ROS resource files
├── test/  # Test scripts for code quality and compliance
│   ├── test_copyright.py  
│   ├── test_flake8.py  
│   ├── test_pep257.py  
│   └── logs/  # Test logs
├── tcp_log_client.py  # Example Python TCP client for live log streaming
```

---

## Features

- **ROS 2 Telemetry Logging:** Subscribes to key flight telemetry topics (battery, GPS, IMU, pose, etc.)
- **Selective Field Logging:** Logs selected fields from each message to a buffer, periodically flushing to disk
- **CSV & Gzip Support:** Supports plain CSV and gzip-compressed CSV output for efficient storage
- **Live TCP Streaming:** Streams each log entry in real-time to any connected TCP client (JSON format, port 9000)
- **Health Monitoring:** Warns if no data is received for a configurable period
- **Service-based Control:** Start/stop logging via ROS 2 services for flexible control
- **Thread-safe, Non-blocking:** Log writing uses a buffer and thread pool
- **Configurable:** All behavior is easily configurable via a Python dataclass
- **Integrated ML Weather Prediction:** Train and deploy a weather prediction model using drone data. Real-time predictions via TCP client.

---

## Machine Learning Weather Prediction

- **Model Training:**
  - Use `ml_weather/train_model.py` to train a Random Forest model on historical weather data (`data/historical_weather.csv`).
  - Model and scaler are saved in the `models/` directory.
- **Real-Time Prediction:**
  - Use `ml_weather/predict.py --tcp` to connect to the logger's TCP server and predict temperature from live drone data.
  - Supports batch prediction from CSV logs with `--csv <logfile>`.
- **Pipeline Automation:**
  - Use `run_pipeline.sh` to build, launch the logger node, and start the prediction client automatically.

---

## Quickstart

### Prerequisites
- ROS 2 Humble (not tested on Foxy)
- Python 3.7+
- All ROS 2 message dependencies (see `package.xml`)
- Python packages: see `requirements.txt` (install with `pip install -r requirements.txt`)

### 1. Build the Package
```bash
colcon build --packages-select data_collector
```

### 2. Source the Workspace
```bash
source install/setup.bash
```

### 3. Train the Weather Model (optional, only if retraining)
```bash
python3 data_collector/ml_weather/train_model.py
```

### 4. Run the Pipeline (recommended)
```bash
./run_pipeline.sh
```
- This will build, launch the logger node, and start the prediction client in TCP mode.

### 5. Start/Stop Logging (if not using pipeline script)
```bash
ros2 service call /start_logging std_srvs/srv/Trigger
ros2 service call /stop_logging std_srvs/srv/Trigger
```

### 6. View Logs or Live Data
- **Logs:** Check `data_collector/logs/` for `.csv` or `.csv.gz` files
- **Live:** Connect a TCP client to port 9000 to receive real-time log entries as JSON

### 7. Run Prediction Client Manually
```bash
python3 data_collector/ml_weather/predict.py --tcp
```

---

## Configuration

Edit the `LogConfig` dataclass in `my_node.py` to customize logging:

| Parameter | Description | Default |
|-----------|-------------|---------|
| `max_buffer_size` | Number of messages to buffer before writing to disk | 100 |
| `log_dir` | Directory where logs are saved | `data_collector/logs/` |
| `compress_logs` | Enable/disable gzip compression | `True` |
| `health_check_interval` | How often to check for missing messages (s) | 5 |
| `message_timeout` | Time to wait before warning about missing messages (s) | 2 |
| `tcp_stream_rate` | TCP streaming rate (Hz as float, or `'live'`) | `'live'` |

---

## Services

| Service | Type | Description |
|---------|------|-------------|
| `/start_logging` | `std_srvs/Trigger` | Start logging data. Returns success if logging started. |
| `/stop_logging` | `std_srvs/Trigger` | Stop logging and flush buffer to disk. Returns success if stopped. |

Call with:
```bash
ros2 service call /start_logging std_srvs/srv/Trigger
ros2 service call /stop_logging std_srvs/srv/Trigger
```

---

## Output

- **Default directory:** `data_collector/logs/` (configurable)
- **Filenames:** `drone_log_YYYYMMDD_HHMMSS.csv` or `.csv.gz`
- **Row format:** timestamp (UTC, ISO8601), topic, sequence number, and selected fields
- **Compression:** If enabled, files are written as gzip-compressed CSVs
- **Live streaming:** Each log entry is also sent as a JSON line to all connected TCP clients

---

## Live TCP Streaming

- **TCP server:** Port 9000 (default)
- **Stream rate:**
  - Set `tcp_stream_rate` in `LogConfig` (see above)
  - Number (e.g. `1.0`): send latest data for each topic at that rate (Hz)
  - `'live'`: stream each message instantly as received
- **Connect with:**
```bash
python3 tcp_log_client.py --host 127.0.0.1 --port 9000
```
- Each line is a JSON object with the same fields as the CSV log.
- **ML Prediction:**
  - Connect with `python3 data_collector/ml_weather/predict.py --tcp` to receive predictions from live drone data.

---

## Troubleshooting

- **No logs written:** Ensure the node is running and logging is started via the service call.
- **No output files:** Check `data_collector/logs/` and verify compression with `file data_collector/logs/*.csv.gz`.
- **Missing fields/errors:** Review node console output for warnings.
- **Permission errors:** Ensure write access to the log directory.
- **ROS 2 environment issues:** Source the correct setup script.
- **Shutdown warnings about `rosout`:** These are suppressed in the latest version.
- **Terminal errors:** If `gnome-terminal` fails, use `xterm` or run processes in background shells.

---

## License

This project is licensed under the terms of the MIT license. See [LICENSE](LICENSE) for details.
